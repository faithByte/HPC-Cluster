- name: Download Docker
  hosts: all
  become: yes
  tasks:
    - name: Check if docker exist
      ansible.builtin.command:
        cmd: docker -v
      register: checkDocker
      ignore_errors: true

    - name: 
      ansible.builtin.debug:
        msg: "Docker is installed"
      when: checkDocker.rc == 0

    - name: Docker already exist
      ansible.builtin.meta: end_play
      when: checkDocker.rc == 0

    - name: Update
      ansible.builtin.apt:
        update_cache: yes

    - name: Install dependancies
      ansible.builtin.apt:
        pkg:
        - ca-certificates 
    
    - name:
      ansible.builtin.command:
        cmd: install -m 0755 -d /etc/apt/keyrings

    - name: Download the docker GPG file
      ansible.builtin.get_url:
        url: "https://download.docker.com/linux/debian/gpg"
        dest: "/etc/apt/keyrings/docker.asc"

    - name: Change GPG file permissions
      file:
        path: "/etc/apt/keyrings/docker.asc"
        mode: "0444"

    - name: System architecture
      ansible.builtin.command:
        cmd: dpkg --print-architecture
      register: architecture

    - name: System codename
      ansible.builtin.shell: "grep '^VERSION_CODENAME=' /etc/os-release | cut -d = -f2"
      register: codename
    
    # - name: ---
    #   ansible.builtin.debug:
    #     msg: "{{ architecture.stdout }} {{ codename.stdout }}"

    - name: Add Docker to apt repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ architecture.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ codename.stdout }} stable"
        filename: /etc/apt/sources.list.d/docker.list
        state: present

    - name: Update
      ansible.builtin.apt:
        update_cache: yes

    - name: Install docker
      ansible.builtin.apt:
        pkg:
        - docker-ce

    - name: Enable & start docker
      ansible.builtin.systemd:
        name: "docker"
        enabled: yes
        state: restarted

- name: Install manapy
  hosts: all
  become: yes
  tasks:
    - name: Copy dockerfile
      ansible.builtin.copy:
        src: ./Dockerfile
        dest: .
        force: yes

    - name: Build docker image
      community.docker.docker_image:
        build: 
          path: .
        source: build
        name: "{{ DOCKER_IMAGE_NAME }}"
        # state: present
      register: output

    - name: Start container
      community.docker.docker_container:
        name: "{{ DOCKER_CONTAINER_NAME }}"
        image: "{{ DOCKER_IMAGE_NAME }}"
      register: output
